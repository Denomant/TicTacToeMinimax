
name: Build portable app-images with jpackage
on: push

env:
  APP_NAME: "TicTacToeMinimax"
  APP_VERSION: "1.0"
  MAIN_CLASS: "App"                
  JAR_NAME: "Zaltsberg_ICS3U_RST-1.0.jar"

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Ensure gradlew is executable (non-Windows)
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      - name: Build project and create installDist
        # installDist produces build/install/<project> with bin/ and lib/
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            cmd.exe /c gradlew.bat clean installDist
          else
            ./gradlew clean installDist
          fi
        shell: bash

      - name: Show install folder contents (debug)
        run: ls -la build/install || true

      - name: Find distribution folder (non-Windows)
        if: runner.os != 'Windows'
        id: find_dist
        run: |
          dist=$(ls build/install | head -n 1)
          echo "dist=$dist" >> $GITHUB_OUTPUT
          echo "Found distribution: $dist"
        shell: bash

      - name: Find distribution folder (Windows)
        if: runner.os == 'Windows'
        id: find_dist
        shell: powershell
        run: |
          $first = Get-ChildItem -Path build\install | Select-Object -First 1
          if ($first) {
            Write-Output ("dist={0}" -f $first.Name) | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Host "Found distribution: $($first.Name)"
          } else {
            Write-Error "No distribution folder found under build\\install"
            exit 1
          }

      - name: Determine JAR to package (non-Windows)
        if: runner.os != 'Windows'
        id: choose_jar
        run: |
          dist="${{ steps.find_dist.outputs.dist }}"
          if [ "${JAR_NAME}" = "auto" ]; then
            jar=$(ls build/install/"$dist"/lib/*.jar | head -n 1)
            jarname=$(basename "$jar")
          else
            jarname="${JAR_NAME}"
          fi
          echo "jarname=$jarname" >> $GITHUB_OUTPUT
          echo "Using jar: $jarname"
        shell: bash

      - name: Determine JAR to package (Windows)
        if: runner.os == 'Windows'
        id: choose_jar
        shell: powershell
        run: |
          $dist = (Get-Content $env:GITHUB_OUTPUT -Raw -ErrorAction SilentlyContinue) -match 'dist=(.+)' | Out-Null
          # simpler: list build\install and take first
          $first = Get-ChildItem -Path build\install | Select-Object -First 1
          if ($env:JAR_NAME -eq 'auto') {
            $jarFull = Get-ChildItem -Path ("build\install\" + $first.Name + "\lib\*.jar") | Select-Object -First 1
            if (-not $jarFull) { Write-Error "No jar found"; exit 1 }
            $jarname = $jarFull.Name
          } else {
            $jarname = $env:JAR_NAME
          }
          Write-Host "jarname=$jarname"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "jarname=$jarname"

      - name: Create app-image with jpackage (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          set -e
          dist="${{ steps.find_dist.outputs.dist }}"
          jar="${{ steps.choose_jar.outputs.jarname }}"
          mkdir -p out
          echo "Using distribution: $dist"
          echo "JAR to use: $jar"
          # input directory must contain the main jar + dependency jars (installDist/lib does)
          jpackage \
            --type app-image \
            --input "build/install/$dist/lib" \
            --main-jar "$jar" \
            --main-class "${MAIN_CLASS}" \
            --name "${APP_NAME}" \
            --app-version "${APP_VERSION}" \
            --dest out \
            --verbose
        shell: bash

      - name: Create app-image with jpackage (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $dist = (Get-ChildItem build\install | Select-Object -First 1).Name
          $jar = (Get-ChildItem "build\install\$dist\lib\*.jar" | Select-Object -First 1).Name
          New-Item -ItemType Directory -Force -Path out | Out-Null
          Write-Host "Using distribution: $dist"
          Write-Host "JAR to use: $jar"
          jpackage.exe --type app-image `
            --input "build\install\$dist\lib" `
            --main-jar $jar `
            --main-class $env:MAIN_CLASS `
            --name $env:APP_NAME `
            --app-version $env:APP_VERSION `
            --dest out `
            --verbose

      - name: List out/ directory
        run: ls -la out || true
        if: always()

      - name: Upload app-image artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ matrix.os }}-app-image-${{ env.APP_NAME }}-${{ env.APP_VERSION }}"
          path: out
